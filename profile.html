<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <title>BiCoder</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="Responsive bootstrap 4 admin template" name="description">
    <meta content="Coderthemes" name="author">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <!-- App favicon -->
    <link rel="shortcut icon" href="assets/images/favicon.ico">
    <link rel="stylesheet" href="assets/css/bootstrap.min.css">

    <!-- Plugins css-->
    <link href="assets/libs/sweetalert2/sweetalert2.min.css" rel="stylesheet" type="text/css">

    <!-- App css -->
    <link href="assets/css/bootstrap.min.css" rel="stylesheet" type="text/css" id="bootstrap-stylesheet">
    <link href="assets/css/icons.min.css" rel="stylesheet" type="text/css">
    <link href="assets/css/app.min.css" rel="stylesheet" type="text/css" id="app-stylesheet">

    <!-- third party css -->
    <link href="assets/libs/datatables/dataTables.bootstrap4.min.css" rel="stylesheet" type="text/css">
    <link href="assets/libs/datatables/buttons.bootstrap4.min.css" rel="stylesheet" type="text/css">
    <link href="assets/libs/datatables/responsive.bootstrap4.min.css" rel="stylesheet" type="text/css">
    <link href="assets/libs/datatables/select.bootstrap4.min.css" rel="stylesheet" type="text/css">

    <!-- Tambahkan CSS CounterUp -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jquery.counterup/1.0.8/jquery.counterup.min.css">

    
    <!-- Custom CSS for Loading Spinner -->
    <style>
        #loadingSpinner {
            margin: 20px 0;
        }

        .spinner-border {
            width: 3rem;
            height: 3rem;
            border-width: .4em;
            color: rgb(47, 47, 230);
        }

        .hidden {
            display: none;
        }

        .ion-md-eye {
            cursor: pointer;
            transition: color 0.3s ease, transform 0.3s ease;
        }

        .ion-md-eye:hover {
            color: #ff4081;
            transform: scale(1.1);
        }

        .ion-md-construct {
            cursor: pointer;
            transition: color 0.3s ease, transform 0.3s ease;
        }

        .ion-md-construct:hover {
            color: #6023da;
            transform: scale(1.1);
        }
    </style>
    <style>
        /* Style untuk lingkaran profil dengan initial */
            .profile-initial {
                width: 80px; /* Sesuaikan ukuran gambar profil */
                height: 80px;
                background-color: #4fdce6; /* Warna background lingkaran */
                color: white; /* Warna text (initial) */
                display: flex; /* Flexbox untuk memusatkan teks di dalam lingkaran */
                justify-content: center; /* Memusatkan teks secara horizontal */
                align-items: center; /* Memusatkan teks secara vertikal */
                font-size: 36px; /* Ukuran font untuk inisial */
                font-weight: bold; /* Menebalkan inisial */
                border-radius: 50%; /* Membuat elemen berbentuk lingkaran */
                margin: 0 auto; /* Memusatkan lingkaran di dalam kolom */
                margin-bottom: 10px; /* Memberi jarak antara lingkaran dan nama */
            }
        .user-details {
            margin-top: 30px;          /* Jarak antara lingkaran dan nama */
            text-align: center;        /* Pusatkan teks nama pengguna secara horizontal */
        }

        .pro-user-name2 {
            font-size: 20px; /* Ukuran teks nama pengguna */
            font-weight: bold; /* Membuat teks tebal */
            text-align: center; /* Memusatkan teks di bawah gambar profil */
            display: block;
        }

        /* Mengatur agar elemen di dalam col-sm-12 diatur dalam satu kolom dan center */
        .text-center {
            text-align: center; /* Memastikan elemen teks terpusat */
        }
        .badge-notification {
            background-color: red; /* Warna latar belakang merah */
            color: white; /* Warna teks putih */
            padding: 2px 6px; /* Padding untuk memberi ruang di dalam kotak */
            border-radius: 20%; /* Membuat sudut menjadi bulat */
            font-size: 12px; /* Ukuran teks yang lebih kecil */
            font-weight: bold; /* Teks tebal */
            margin-left: 8px; /* Beri sedikit jarak antara teks dan badge */
            display: inline-block; /* Agar elemen tampil inline */
        }
    </style>

    <!-- Script to check login status -->
    <script>
        // Periksa status login ketika halaman dimuat
        document.addEventListener('DOMContentLoaded', function () {
            if (!sessionStorage.getItem('isLoggedIn')) {
                // Jika tidak ada status login, alihkan ke halaman login
                window.location.href = 'index.html';
            }
        });
    </script>

</head>

<body>

    <!-- Begin page -->
    <div id="wrapper">
        <!-- Topbar Start -->
        <div class="navbar-custom">
            <ul class="list-unstyled topnav-menu float-right mb-0">
                <li class="dropdown notification-list">
                    <a class="nav-link dropdown-toggle nav-user mr-0 waves-effect" data-toggle="dropdown" href="#"
                        role="button" aria-haspopup="false" aria-expanded="false">
                        <img src="assets/images/users/a3.jpg" alt="user-image" class="rounded-circle">
                        <span class="pro-user-name ml-1">
                            <span id="tampil_nama1"></span>
                            <i class="mdi mdi-chevron-down"></i>
                        </span>
                    </a>
                    <div class="dropdown-menu dropdown-menu-right profile-dropdown ">
                        <div class="dropdown-header noti-title">
                            <h6 class="text-overflow m-0">Welcome ! </h6>
                        </div>
                        <a href="profile.html" class="dropdown-item notify-item">
                            <i class="mdi mdi-account-outline"></i>
                            <span>Profile</span>
                        </a>
                        <div class="dropdown-divider"></div>
                        <a href="javascript:void(0);" id="logoutButton" class="dropdown-item notify-item">
                            <i class="mdi mdi-logout-variant"></i>
                            <span>Logout</span>
                        </a>
                    </div>
                </li>
            </ul>
            <div class="logo-box">
                <a href="main.html" class="logo text-center ">
                    <span class="logo-lg">
                        <img src="assets/images/logo-dark1.png" alt="" height="30">
                    </span>
                    <span class="logo-sm">
                        <img src="assets/images/logo-smb.png" alt="" height="22">
                    </span>
                </a>
            </div>
            <ul class="list-unstyled topnav-menu topnav-menu-left m-0">
                <li>
                    <button class="button-menu-mobile waves-effect">
                        <i class="mdi mdi-menu"></i>
                    </button>
                </li>
            </ul>
        </div>
        <!-- end Topbar -->

        <!-- ========== Left Sidebar Start ========== -->
        <div class="left-side-menu">
            <div class="slimscroll-menu">
                <div id="sidebar-menu">
                    <ul class="metismenu" id="side-menu">
                        <li id="menu-dashboard">
                            <a href="main.html">
                                <i class=" ion ion-ios-home"></i>
                                <span> Dashboard </span>
                            </a>
                        </li>
                        <li id="menu-data-users">
                            <a href="data-users.html">
                                <i class="ion ion-ios-contacts"></i>
                                <span> Data Users </span>
                            </a>
                        </li>
                        <li>
                            <a href="data-part.html">
                                <i class="ion ion-ios-construct"></i>
                                <span> Data Parts </span>
                            </a>
                        </li>
                        <li id="menu-add-stock">
                            <a href="add-stock.html">
                                <i class="ion ion-md-cube"></i>
                                <span> Penambahan Stock </span>
                            </a>
                        </li>

                        <li id="menu-get-barang">
                            <a href="get-barang-user.html">
                                <i class="ion ion-ios-basket"></i>
                                <span> Permintaan Barang </span>
                            </a>
                        </li>
                        <li id="menu-barang">
                            <a href="javascript: void(0);" class="waves-effect">
                                <i class="ion ion-ios-basket"></i>
                                <span>Pengambilan Barang</span>
                                <span class="menu-arrow"></span>
                            </a>
                            <ul class="nav-second-level nav" aria-expanded="false">
                                <li>
                                    <a href="get-barang2.html">Permintaan Barang <span id="pendingCount"></span></a>
                                </li>
                                <li>
                                    <a href="get-barang3.html">Verified</a>
                                </li>  
                                <li>
                                    <a href="get-log.html">Event Log</a>
                                </li>             
                            </ul>
                        </li>

                        <li id="menu-report">
                            <a href="javascript: void(0);" class="waves-effect">
                                <i class="mdi mdi-share-variant"></i>
                                <span> Report </span>
                                <span class="menu-arrow"></span>
                            </a>
                            <ul class="nav-second-level nav" aria-expanded="false">
                                <li>
                                    <a href="Laporan-DP.html">Data Parts</a>
                                </li>
                                <li>
                                    <a href="Laporan-pb.html">Data Pengambilan Barang</a>
                                </li>
                                <li>                     
                                    <a href="Laporan-SM.html">Data Stock Minim</a>
                                </li>                 
                                        
                            </ul>
                        </li>
                    </ul>
                </div>
                <div class="clearfix"></div>
            </div>
        </div>
        <!-- Left Sidebar End -->
        <!-- ============================================================== -->
        <!-- Start Page Content here -->
        <!-- ============================================================== -->
        <div class="content-page">
            <div class="content">
                <div class="container-fluid">

                    <!-- start page title -->
                    <div class="row">
                        <div class="col-sm-12">
                            <div class="profile-bg-picture"
                                style="background-image:url('assets/images/coder.jpg')">
                                <span class="picture-bg-overlay"></span>
                            </div>
                            <div class="profile-user-box">
                                <div class="row">
                                    <div class="col-sm-12">
                                         <!-- Gantikan gambar profil dengan div untuk initial -->
                                    <div id="profileInitial" class="profile-initial"></div>
                                    <div class="">
                                        <span class="pro-user-name2 ml-1">
                                            <span class="text-center" id="tampil_nama2"></span> 
                                          
                                        </span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- end row -->

                    <div class="row mt-4">
                        <div class="col-sm-12">
                            <div class="card p-0">
                                <div class="card-body p-0">
                                    <ul class="nav nav-tabs tabs-bordered nav-justified">
                                        <li class="nav-item"><a class="nav-link" data-toggle="tab">Edit Profile</a></li>

                                    </ul>

                                    <div class="container">
                                        <h3></h3>
                                        <form id="editForm">
                                            <div class="form-group">
                                                <label for="editUsername">User Name</label>
                                                <input type="text" class="form-control" id="editUsername" name="username" required readonly>
                                            </div>
                                            <div class="form-group">
                                                <label for="editEmail">Email</label>
                                                <input type="email" class="form-control" id="editEmail" name="email" required>
                                            </div>
                                            <div class="form-group">
                                                <label for="editPassword">Password</label>
                                                <input type="password" class="form-control" id="editPassword" name="password" required>
                                            </div>
                                            <button type="submit" class="btn btn-primary">Update Profile</button>
                                            <div id="updateMessage" class="mt-3"></div>
                                            <div id="loadingSpinner" class="spinner-border hidden" role="status">
                                                <span class="sr-only">Loading...</span>
                                            </div>
                                        </form>
                                    </div>
                                            <div id="loadingSpinner" class="hidden">
                                                <div class="spinner-border" role="status"></div>
                                            </div>
                                            <div id="updateMessage"></div>
                                        </div>
                                    </div>
                                    <!-- end tab-content -->
                                </div>
                                <!-- end card-body -->
                            </div>
                            <!-- end card -->
                        </div>
                    </div>
                    <!-- end row -->
                </div> <!-- container-fluid -->
            </div> <!-- content -->
        </div> <!-- content-page -->
         <!-- Footer Start -->
         <footer class="footer">
            <div class="container-fluid">
                <div class="row">
                    <div class="col-md-12">
                        2024 &copy; powered by <a href="">BiCoder | Version 2</a>
                    </div>
                </div>
            </div>
        </footer>
        <!-- end Footer -->
    </div>
    
    <!-- End Right content here -->

    
    <!-- Right bar overlay -->
    <div class="rightbar-overlay"></div>

    <!-- Vendor js -->
    <script src="assets/js/vendor.min.js"></script>

    <!-- Plugins js -->
    <script src="assets/libs/sweetalert2/sweetalert2.min.js"></script>
    <script src="assets/libs/datatables/jquery.dataTables.min.js"></script>
    <script src="assets/libs/datatables/dataTables.bootstrap4.min.js"></script>
    <script src="assets/libs/datatables/dataTables.responsive.min.js"></script>
    <script src="assets/libs/datatables/responsive.bootstrap4.min.js"></script>
    <script src="assets/libs/datatables/dataTables.buttons.min.js"></script>
    <script src="assets/libs/datatables/buttons.bootstrap4.min.js"></script>
    <script src="assets/libs/datatables/buttons.html5.min.js"></script>
    <script src="assets/libs/datatables/buttons.flash.min.js"></script>
    <script src="assets/libs/datatables/buttons.print.min.js"></script>
    <script src="assets/libs/datatables/pdfmake.min.js"></script>
    <script src="assets/libs/datatables/vfs_fonts.js"></script>

    <!-- App js -->
    <script src="assets/js/app.min.js"></script>

    <!-- Logout Script -->
    <script>
        document.getElementById('logoutButton').addEventListener('click', function() {
            sessionStorage.removeItem('isLoggedIn');
            window.location.href = 'index.html';
        });

        document.addEventListener('DOMContentLoaded', function() {
    const scriptURL = 'https://script.google.com/macros/s/AKfycbypjjsM2tpbpqcGGLivgQ0mjgSkrmK8DfMfuBZ_g3YC_a7fWv8A4s8v0Z51RaqNYbXG0w/exec?action=readPending';

    // Fetch data dari URL
    fetch(scriptURL)
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const pendingCount = data.data.length; // Hitung jumlah total data
                updateMenuWithPendingCount(pendingCount); // Panggil fungsi untuk memperbarui menu
            } else {
                console.error('Error:', data.message);
            }
        })
        .catch(error => {
            console.error('Error fetching data:', error);
        });
});

// Fungsi untuk memperbarui menu dengan jumlah pending
function updateMenuWithPendingCount(pendingCount) {
    const pendingCountSpan = document.getElementById('pendingCount'); // Ambil elemen dengan id pendingCount
    if (pendingCountSpan) {
        if (pendingCount > 0) {
            pendingCountSpan.textContent = pendingCount; // Hanya tampilkan angka, tanpa tanda kurung
            pendingCountSpan.classList.add('badge-notification'); // Tambahkan kelas badge-notification untuk gaya
        } else {
            pendingCountSpan.textContent = ''; // Kosongkan jika tidak ada pending
            pendingCountSpan.classList.remove('badge-notification'); // Hapus kelas jika tidak ada data
        }
    }
}

// Ambil peran pengguna dari sessionStorage
const userRole = sessionStorage.getItem('role');

if (userRole !== 'user') {
    const menuGetBarang = document.getElementById('menu-get-barang');
    if (menuGetBarang) {
        menuGetBarang.style.display = 'none';
    }
} 

// Sembunyikan menu berdasarkan role
if (userRole !== 'admin' && userRole !== 'superadmin') {
    // Sembunyikan menu "Data Users"
    const menuDataUsers = document.getElementById('menu-data-users');
    if (menuDataUsers) {
        menuDataUsers.style.display = 'none';
    }

    // Sembunyikan menu "Report"
    const menuReport = document.getElementById('menu-report');
    if (menuReport) {
        menuReport.style.display = 'none';
    }

    // Sembunyikan menu "Add Stock"
    const menuAddStock = document.getElementById('menu-add-stock');
    if (menuAddStock) {
        menuAddStock.style.display = 'none';
    }
    const menuBarang = document.getElementById('menu-barang');
    if (menuBarang) {
        menuBarang.style.display = 'none';
    }
}
    </script>

    <script>
        // Fungsi untuk menampilkan nama pengguna dan initial yang login
        function displayUserInitial() {
            const username = sessionStorage.getItem('username');
            
            if (username) {
                // Tampilkan nama pengguna
                document.getElementById('tampil_nama1').textContent = username;
                document.getElementById('tampil_nama2').textContent = username;
                
                // Tampilkan initial
                const initial = username.charAt(0).toUpperCase();
                document.getElementById('profileInitial').textContent = initial;
            } else {
                alert('Pengguna belum login!');
                window.location.href = 'login.html';
            }
        }
    
        // Fungsi untuk mengambil dan menampilkan data pengguna
        function displayUserData() {
            const userId = sessionStorage.getItem('id');
    
            if (!userId) {
                alert('Pengguna belum login!');
                window.location.href = 'login.html';
                return;
            }
    
            console.log('Fetching data for user ID:', userId);
    
            // Mengambil data pengguna dari server menggunakan ID
            fetch(`https://script.google.com/macros/s/AKfycbwuAGfMOV0Qit84uH_tglWDckzRfQG6Ovm3os9I2A_QhVdkeBMiy93LjfNf5ICe9kvUmQ/exec?action=getUserById&id=${userId}`)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        const user = data.data;
                        // Isi form dengan data pengguna
                        document.getElementById('editUsername').value = user.username;
                        document.getElementById('editEmail').value = user.email;
                        document.getElementById('editPassword').value = user.password.substring(0, 10);
                        
                        // Sebaiknya jangan tampilkan password, jika diperlukan
                    } else {
                        console.error('Error:', data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    
        // Fungsi untuk memperbarui data pengguna
        function updateUser(event) {
            event.preventDefault(); // Mencegah pengiriman form langsung
            const loadingSpinner = document.getElementById('loadingSpinner');
            const updateMessage = document.getElementById('updateMessage');
    
            loadingSpinner.classList.remove('hidden'); // Tampilkan loading spinner
            updateMessage.textContent = ''; // Reset pesan
    
            const id = sessionStorage.getItem('id');
            const username = document.getElementById('editUsername').value;
            const password = document.getElementById('editPassword').value;
            const email = document.getElementById('editEmail').value;
    
            // Kirim data yang telah diubah ke server
            fetch('https://script.google.com/macros/s/AKfycbwuAGfMOV0Qit84uH_tglWDckzRfQG6Ovm3os9I2A_QhVdkeBMiy93LjfNf5ICe9kvUmQ/exec?action=update', {
                method: 'POST',
                body: new URLSearchParams({
                    id: id,
                    username: username,
                    password: password,
                    email: email
                })
            })
            .then(response => response.json())
            .then(data => {
                loadingSpinner.classList.add('hidden'); // Sembunyikan loading spinner
                if (data.status === 'success') {
                    Swal.fire('Updated!', 'User has been updated.', 'success')
                        .then(() => {
                            const row = document.querySelector(`button.edit-btn[data-id="${id}"]`).closest('tr');
                            row.cells[0].textContent = username;
                            row.cells[1].textContent = email; // Jangan tunjukkan password
                            $('#editModal').modal('hide'); // Sembunyikan modal edit
                        });
                } else {
                    Swal.fire('Error!', 'There was an error updating the user: ' + data.message, 'error');
                }
            })
            .catch(error => {
                loadingSpinner.classList.add('hidden');
                Swal.fire('Error!', 'An error occurred: ' + error.message, 'error');
            })
            .finally(() => {
                updateMessage.textContent = 'Save Changes';
            });
        }
    
        // Event listener yang menggabungkan fungsi-fungsi di atas
        window.onload = function () {
            displayUserInitial();  // Menampilkan initial
            displayUserData();     // Menampilkan data pengguna di form
    
            // Event listener untuk form edit
            document.getElementById('editForm').addEventListener('submit', updateUser);
        };
    </script>
    
</body>

</html>
