<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Laporan Data Parts</title>
    <link rel="stylesheet" href="https://cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
</head>
<body>
    <h1>Laporan Data Parts</h1>
    
    <!-- Loading Spinner -->
    <div id="loadingSpinner" style="display: none;">
        <p>Loading...</p>
    </div>

    <!-- Filter Form -->
    <div class="form-group">
        <label for="filterColumn">Filter Berdasarkan Kolom:</label>
        <select id="filterColumn" class="form-control">

            <!-- <option value="">--Pilih--</option> -->
            <option value="id_part">ID Part</option>
            <option value="description">Description</option>
            <option value="specification">Specification</option>
            <option value="location">Location</option>
            <!-- Tambahkan kolom lainnya -->
        </select>

        <label for="filterValue">Nilai Filter:</label>
        <input type="text" id="filterValue" class="form-control" placeholder="Masukkan nilai filter">

        <button id="applyFilter" class="btn btn-primary">Terapkan Filter</button>
    </div>

    <!-- Tabel Data -->
    <table id="userTable" class="table table-bordered">
        <thead>
            <tr>
                <th>ID Part</th>
                <th>Description</th>
                <th>Specification</th>
                <th>Machine</th>
                <th>Supplier 1</th>
                <th>Supplier 2</th>
                <th>Location</th>
                <th>Type Part</th>
                <th>Min</th>
                <th>Max</th>
                <th>Unit</th>
                <th>Lead Time (Day)</th>
                <th>Stock</th>
                <th>Price</th>
                <th>Total Value</th>
                <th>Total Sparepart Cost</th>
                <th>Condition</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const scriptURL = 'https://script.google.com/macros/s/AKfycbwwwWDOmSCm8tRABze_aYK7igCbIKAQ_hf4h27rxCF_VOuBQf4c_NMET-wzEqMiJ1gYhg/exec?action=read';
            const loadingSpinner = document.getElementById('loadingSpinner');
            const filterColumn = document.getElementById('filterColumn');
            const filterValue = document.getElementById('filterValue');
            const applyFilterButton = document.getElementById('applyFilter');

            function displayData(users) {
                const usersTableBody = document.querySelector('#userTable tbody');
                usersTableBody.innerHTML = ''; // Kosongkan tabel sebelum memuat data baru

                users.forEach(user => {
                    const row = usersTableBody.insertRow();
                    row.insertCell(0).textContent = user.id_part;
                    row.insertCell(1).textContent = user.description;
                    row.insertCell(2).textContent = user.specification;
                    row.insertCell(3).textContent = user.machine;
                    row.insertCell(4).textContent = user.supplier1;
                    row.insertCell(5).textContent = user.supplier2;
                    row.insertCell(6).textContent = user.location;
                    row.insertCell(7).textContent = user.type_part;
                    row.insertCell(8).textContent = user.min;
                    row.insertCell(9).textContent = user.max;
                    row.insertCell(10).textContent = user.unit;
                    row.insertCell(11).textContent = user.lt_day;
                    row.insertCell(12).textContent = user.stock;
                    row.insertCell(13).textContent = user.price;
                    row.insertCell(14).textContent = user.total_value;
                    row.insertCell(15).textContent = user.total_sparepart_cost;
                    row.insertCell(16).textContent = user.condition;
                });

                // Inisialisasi ulang DataTable setelah memuat data
                if ($.fn.DataTable.isDataTable('#userTable')) {
                    $('#userTable').DataTable().destroy(); // Hancurkan instance DataTable yang ada     
                }

                $('#userTable').DataTable({
                    responsive: true  // Menjaga agar tabel tetap responsif
                });
            }

            function fetchData(showMinData = false, filter = {}) {
                loadingSpinner.style.display = 'block';

                fetch(scriptURL)
                    .then(response => response.json())
                    .then(data => {
                        if (data.status === 'success') {
                            let users = data.data;

                            if (showMinData) {
                                users = users.filter(user => user.stock < user.min);
                            }

                            // Jika ada filter, lakukan filtering
                            if (filter.column && filter.value) {
                                users = users.filter(user => {
                                    const columnValue = user[filter.column].toString().toLowerCase();
                                    return columnValue.includes(filter.value.toLowerCase());
                                });
                            }

                            displayData(users);
                        } else {
                            console.error('Error:', data.message);
                        }
                    })
                    .catch(error => console.error('Error:', error))
                    .finally(() => {
                        loadingSpinner.style.display = 'none';
                    });
            }

           // Fetch data saat halaman dimuat
           fetchData();

           // Event listener untuk tombol filter
           applyFilterButton.addEventListener('click', () => {
               const filterColumnValue = filterColumn.value;
               const filterValueText = filterValue.value;
               
               fetchData(false, { column: filterColumnValue, value: filterValueText });
           });
       });
   </script>
</body>
</html>
