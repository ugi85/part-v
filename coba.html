<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Pengambilan Barang</title>
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@10"></script>
</head>
<body>

<!-- Modal Edit -->
<div class="modal fade" id="editModal" tabindex="-1" role="dialog" aria-labelledby="editItemModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editItemModalLabel">Edit Pengambilan Barang</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editForm">
                    <input type="hidden" id="editId" name="id">
                    <div class="form-group">
                        <label for="editTanggal">Tanggal</label>
                        <input type="date" class="form-control" id="editTanggal" name="tanggal" required>
                        <div class="invalid-feedback">Date is required.</div>
                    </div>
                    <div class="form-group">
                        <label for="editWaktu">Waktu</label>
                        <input type="time" class="form-control" id="editWaktu" name="waktu" required>
                        <div class="invalid-feedback">Time is required.</div>
                    </div>
                    <div class="form-group">
                        <label for="editDepartemen">Departemen</label>
                        <select class="form-control" id="editDepartemen" name="departemen" required>
                            <option value="" disabled selected>Select Department</option>
                            <option value="FMEHSS EHS">FMEHSS EHS</option>
                            <option value="HPS HR+BPE+PTPT+IT">HPS HR+BPE+PTPT+IT</option>
                            <!-- Add other departments here -->
                        </select>
                        <div class="invalid-feedback">Department is required.</div>
                    </div>
                    <div class="form-group">
                        <label for="editMesin">Mesin</label>
                        <input type="text" class="form-control" id="editMesin" name="mesin" required>
                        <div class="invalid-feedback">Machine is required.</div>
                    </div>
                    <div class="form-group">
                        <label for="editRemark">Remark</label>
                        <textarea class="form-control" id="editRemark" name="remark" rows="3"></textarea>
                    </div>

                    <div id="ItemsContainer">
                        <div class="item-row row">
                            <div class="col-md-4">
                                <label for="editPartName">Part Name</label>
                                <select class="form-control" id="editPartName" name="part_name" required>
                                </select>
                            </div>
                            <div class="col-md-3">
                                <label for="editSpecification">Specification</label>
                                <input type="text" class="form-control" id="editSpecification" name="specification" required readonly>
                            </div>
                            <div class="col-md-3">
                                <label for="editStock">Stock</label>
                                <input type="text" class="form-control" id="editStock" name="stock" readonly>
                            </div>
                            <div class="col-md-2">
                                <label for="editQty">Qty</label>
                                <input type="number" class="form-control" id="editQty" name="qty" required>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-group mt-4">
                        <label for="editRequester">Requester</label>
                        <input type="text" class="form-control" id="editRequester" name="requester" required>
                        <div class="invalid-feedback">Requester is required.</div>
                    </div>
                    <div class="form-group">
                        <label for="editStoreKeeper">Store Keeper/Security</label>
                        <input type="text" class="form-control" id="editStoreKeeper" name="security" required>
                        <div class="invalid-feedback">Store Keeper/Security is required.</div>
                    </div>
                    <div class="form-group">
                        <label for="editNote">Note</label>
                        <input type="text" class="form-control" id="editNote" name="note">
                        <div class="invalid-feedback">Status is required.</div>
                    </div>
                    <div class="col-12 text-right">
                        <button type="submit" id="saveChanges" class="btn btn-primary">Save Changes</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
// Ambil nama pengguna dari sessionStorage dan tampilkan di kolom requester
var userName = sessionStorage.getItem('username');
    if (userName) {
        $('#security').val(userName);
    }

    const apiUrlSpecification = 'https://script.google.com/macros/s/AKfycbyZ-D1NP-DKa-eImcXemb_qNWnYBX670Wp6HRG0CQwj-s7D5KOMkvotiZXst9_HG1VhuA/exec?action=getSpecification';
    // const adminName = "John Doe";  // Ambil dari session atau sistem auth yang ada

    function formatDateForInput(dateString) {
        const date = new Date(dateString);
        return date.toISOString().split('T')[0];  // Format 'YYYY-MM-DD'
    }

    function formatTimeForInput(timeString) {
        const date = new Date(timeString);
        return date.toTimeString().split(':').slice(0, 2).join(':');  // Format 'HH:MM'
    }

    async function fetchItemById(userId) {
        try {
            const response = await $.get(`https://script.google.com/macros/s/AKfycbyZ-D1NP-DKa-eImcXemb_qNWnYBX670Wp6HRG0CQwj-s7D5KOMkvotiZXst9_HG1VhuA/exec?action=getItemById&id=${userId}`);
            if (response.status === 'success' && typeof response.data === 'object') {
                const user = response.data;

                $('#editId').val(user.id);
                $('#editTanggal').val(formatDateForInput(user.tanggal));
                $('#editWaktu').val(formatTimeForInput(user.waktu));
                $('#editDepartemen').val(user.departemen);
                $('#editMesin').val(user.mesin);
                $('#editRemark').val(user.remark);
                $('#editPartName').val(user.part_name);
                $('#editSpecification').val(user.specification);
                $('#editQty').val(user.qty);
                $('#editRequester').val(user.requester);

                // Isi kolom Security dengan nama admin dan tanggal saat ini
                const currentDate = new Date().toISOString().split('T')[0]; // Tanggal sekarang
                $('#editStoreKeeper').val(`${userName} - ${currentDate}`);

                // Ambil data stock berdasarkan part_name
                if (user.part_name) {
                    const specResponse = await $.get(apiUrlSpecification, { partName: user.part_name });
                    if (specResponse.partName === user.part_name) {
                        $('#editStock').val(specResponse.stock || 0);  // Tampilkan stock
                    } else {
                        console.error('Part name mismatch or specification data missing');
                    }
                } else {
                    $('#editStock').val(0);  // Default ke 0 jika part_name kosong
                }

                $('#editModal').modal('show');
            } else {
                console.error('Error:', response.message);
                Swal.fire('Error!', 'Failed to fetch data. Please try again.', 'error');
            }
        } catch (error) {
            console.error('Request failed:', error);
            Swal.fire('Error!', 'An error occurred while fetching data.', 'error');
        }
    }

    $(document).on('click', '.edit-btn', function() {
        const userId = $(this).data('id');
        fetchItemById(userId);  // Panggil fungsi async
    });

    $('#editPartName').on('change', async function() {
        const selectedPartName = $(this).val();
        const $specField = $('#editSpecification');
        const $stockField = $('#editStock');

        if (selectedPartName) {
            try {
                const response = await $.get(apiUrlSpecification, { partName: selectedPartName });
                if (response.partName === selectedPartName) {
                    $specField.val(response.specification || '');
                    $stockField.val(response.stock || 0);
                } else {
                    console.error('Part name mismatch or specification data missing');
                }
            } catch (error) {
                console.error('Request failed:', error);
            }
        } else {
            $specField.val('');
        }
    });


    $(document).on('click', '.edit-btn', function() {
    const userId = $(this).data('id');

    // Ambil data item berdasarkan ID
    $.get(`https://script.google.com/macros/s/AKfycbyZ-D1NP-DKa-eImcXemb_qNWnYBX670Wp6HRG0CQwj-s7D5KOMkvotiZXst9_HG1VhuA/exec?action=getItemById&id=${userId}`, function(data) {

        if (data.status === 'success') {
            const user = data.data;

            $('#editId').val(user.id);
            $('#editTanggal').val(formatDateForInput(user.tanggal));
            $('#editWaktu').val(formatTimeForInput(user.waktu));
            $('#editDepartemen').val(user.departemen);
            $('#editMesin').val(user.mesin);
            $('#editRemark').val(user.remark);
            
            // Isi dropdown part name sebelum mengisi nilainya
            populatePartNames(user.part_name);  // Pastikan dropdown sudah terisi

            $('#editSpecification').val(user.specification);
            $('#editQty').val(user.qty);
            $('#editRequester').val(user.requester);
            $('#editStoreKeeper').val(user.security);

            // Ambil data stock berdasarkan part_name
            if (user.part_name) {
                $.get(apiUrlSpecification, { partName: user.part_name }, function(response) {
                    if (response.partName === user.part_name) {
                        $('#editStock').val(response.stock || 0);  // Tampilkan stock
                    } else {
                        console.error('Part name mismatch or specification data missing');
                    }
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    console.error('Request failed:', textStatus, errorThrown);
                });
            } else {
                $('#editStock').val(0);  // Default ke 0 jika part_name kosong
            }

            $('#editModal').modal('show');
        } else {
            console.error('Error:', data.message);
            Swal.fire('Error!', 'Failed to fetch data. Please try again.', 'error');
        }
    }).fail(function(jqXHR, textStatus, errorThrown) {
        console.error('Request failed:', textStatus, errorThrown);
        Swal.fire('Error!', 'An error occurred while fetching data.', 'error');
    });
});

// Fungsi untuk populate dropdown part name
function populatePartNames(selectedPartName) {
    // Ambil semua part name dari API atau daftar yang tersedia
    $.get(apiUrlPartNames, function(response) {
        const partNames = response.partNames;  // Misal response berisi array part names
        const $partNameSelect = $('#editPartName');
        $partNameSelect.empty();  // Kosongkan dropdown

        partNames.forEach(function(partName) {
            const option = $('<option></option>')
                .attr('value', partName)
                .text(partName);
            
            if (partName === selectedPartName) {
                option.attr('selected', 'selected');
            }
            $partNameSelect.append(option);
        });

        // Trigger change event untuk memicu update pada specification dan stock
        $('#editPartName').trigger('change');
    });
}

// Ketika part name diubah
$('#editPartName').on('change', function() {
    const selectedPartName = $(this).val();
    const $specField = $('#editSpecification');
    const $stockField = $('#editStock');

    if (selectedPartName) {
        $.get(apiUrlSpecification, { partName: selectedPartName }, function(response) {
            if (response.partName === selectedPartName) {
                $specField.val(response.specification || '');
                $stockField.val(response.stock || 0);
            } else {
                console.error('Part name mismatch or specification data missing');
            }
        }).fail(function(jqXHR, textStatus, errorThrown) {
            console.error('Request failed:', textStatus, errorThrown);
        });
    } else {
        $specField.val('');
    }
});

// Form submission untuk modal edit
$('#editForm').submit(function(e) {
    e.preventDefault();
    var saveChanges = document.querySelector('#saveChanges');

    saveChanges.disabled = true;
    saveChanges.textContent = 'Loading...';

    const formData = $(this).serialize();

    $.ajax({
        url: 'https://script.google.com/macros/s/AKfycbyZ-D1NP-DKa-eImcXemb_qNWnYBX670Wp6HRG0CQwj-s7D5KOMkvotiZXst9_HG1VhuA/exec?action=update',
        type: 'POST',
        data: formData,
        success: function(response) {
            if (response.status === 'success') {
                Swal.fire({
                    title: 'Updated!',
                    text: 'Item has been updated.',
                    icon: 'success',
                    confirmButtonText: 'OK'
                }).then((result) => {
                    if (result.isConfirmed) {
                        $('#editModal').modal('hide');
                        location.reload(); // Refresh page after user confirms
                    }
                });
            } else {
                Swal.fire('Error!', response.message, 'error');
            }
        },
        error: function(jqXHR, textStatus, errorThrown) {
            console.error('Request failed:', textStatus, errorThrown);
            Swal.fire('Error!', 'An error occurred while updating the item.', 'error');
        }
    })
    .finally(() => {
        // Re-enable the saveChanges button and reset text
        saveChanges.disabled = false;
        saveChanges.textContent = 'Save Changes';
    });
});

</script>


<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.bundle.min.js"></script>
</body>
</html>


