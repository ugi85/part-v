<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Filter with Select2 and API</title>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
</head>
<body>
    <div class="container">
        <h3>Laporan Data Part</h3>
        <div class="row mb-4">
            <!-- Filter Berdasarkan Kolom -->
            <div class="col-md-3">
                <label for="filterColumn">Filter Berdasarkan Kolom:</label>
                <select class="form-control" id="filterColumn">
                    <option value="">--Pilih Kategori--</option>
                    <option value="id_part">ID Part</option>
                    <option value="description">Description</option>
                    <option value="specification">Specification</option>
                    <option value="machine">Machine</option>
                    <option value="supplier_1">Supplier 1</option>
                    <option value="supplier_2">Supplier 2</option>
                    <option value="location">Location</option>
                    <option value="type_part">Type Part</option>
                    <option value="min">Min</option>
                    <option value="max">Max</option>
                    <option value="unit">Unit</option>
                    <option value="lt_day">LT Day</option>
                    <option value="stock">Stock</option>
                    <option value="price">Price</option>
                </select>
            </div>

            <!-- Nilai Filter -->
            <div class="col-md-3">
                <label for="filterValue">Nilai Filter:</label>
                <select class="form-control" id="filterValue">
                    <option value="">Pilih Nilai Filter</option>
                </select>
            </div>

            <!-- Tombol Filter -->
            <div class="col-md-3 d-flex align-items-end">
                <button id="applyFilter" class="btn btn-primary ml-2">Terapkan Filter</button>
            </div>
        </div>

        <table class="table" id="userTable">
            <thead>
                <tr>
                    <th>ID Part</th>
                    <th>Description</th>
                    <th>Specification</th>
                    <th>Machine</th>
                    <th>Supplier 1</th>
                    <th>Supplier 2</th>
                    <th>Location</th>
                    <th>Type Part</th>
                    <th>Min</th>
                    <th>Max</th>
                    <th>Unit</th>
                    <th>LT Day</th>
                    <th>Stock</th>
                    <th>Price</th>
                </tr>
            </thead>
            <tbody>
                <!-- Data will be populated here -->
            </tbody>
        </table>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jspdf-autotable@3.5.20/dist/jspdf.plugin.autotable.js"></script>

    <script>
        const scriptURL = 'https://script.google.com/macros/s/AKfycbwwwWDOmSCm8tRABze_aYK7igCbIKAQ_hf4h27rxCF_VOuBQf4c_NMET-wzEqMiJ1gYhg/exec?action=read'; // Ganti dengan API endpoint Anda
        let originalData = []; // Untuk menyimpan data asli dari API

        // Inisialisasi select2 untuk filterValue
        $(document).ready(function() {
            $('#filterValue').select2({
                placeholder: 'Pilih Nilai Filter',
                allowClear: true
            });
        });

        // Fungsi untuk menampilkan data
        function displayData(users) {
            const tableBody = document.querySelector('#userTable tbody');
            tableBody.innerHTML = ''; // Kosongkan data sebelumnya

            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id_part}</td>
                    <td>${user.description}</td>
                    <td>${user.specification}</td>
                    <td>${user.machine}</td>
                    <td>${user.supplier_1}</td>
                    <td>${user.supplier_2}</td>
                    <td>${user.location}</td>
                    <td>${user.type_part}</td>
                    <td>${user.min}</td>
                    <td>${user.max}</td>
                    <td>${user.unit}</td>
                    <td>${user.lt_day}</td>
                    <td>${user.stock}</td>
                    <td>${user.price}</td>
                `;
                tableBody.appendChild(row);
            });
        }

        // Fungsi untuk mengambil data dari API
        function fetchDataFromAPI() {
            fetch(scriptURL)
                .then(response => response.json())
                .then(data => {
                    if (data.status === 'success') {
                        originalData = data.data; // Simpan data asli dari API
                        displayData(originalData); // Tampilkan data pada tabel saat load pertama kali
                    } else {
                        console.error('Error:', data.message);
                    }
                })
                .catch(error => console.error('Error:', error));
        }

        // Fungsi untuk filter data
        function fetchData(filter = {}) {
            let users = [...originalData]; // Salin data untuk filter

            if (filter.column && filter.value) {
                users = users.filter(user => {
                    const columnValue = user[filter.column];

                    // Filter berdasarkan nilai yang dipilih
                    return columnValue && columnValue.toString().toLowerCase().includes(filter.value.toString().toLowerCase());
                });
            }

            displayData(users); // Tampilkan hasil filter
        }

        // Event listener untuk kolom filter
        filterColumn.addEventListener('change', () => {
            const filterColumnValue = filterColumn.value;

            // Kosongkan opsi sebelumnya
            $('#filterValue').empty().trigger('change');

            if (filterColumnValue) {
                // Ambil nilai dari kolom yang dipilih
                const options = [...new Set(originalData.map(user => user[filterColumnValue]))];

                // Tambahkan opsi ke select2
                options.forEach(option => {
                    const newOption = new Option(option, option, false, false);
                    $('#filterValue').append(newOption).trigger('change');
                });
            }
        });

        // Event listener untuk tombol filter
        applyFilterButton.addEventListener('click', () => {
            const filterColumnValue = filterColumn.value; // Kolom yang akan difilter
            const filterValueSelected = $('#filterValue').val(); // Dapatkan nilai yang dipilih dari select2

            // Panggil fungsi fetchData dengan kolom dan nilai yang dipilih
            fetchData({
                column: filterColumnValue,
                value: filterValueSelected
            });

            // Reset filter setelah diterapkan jika diperlukan
            filterColumn.value = '';
            $('#filterValue').val(null).trigger('change'); // Reset select2
        });

        // Panggil API dan tampilkan data saat halaman load pertama kali
        fetchDataFromAPI();
    </script>
</body>
</html>
